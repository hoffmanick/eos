---
title: "South Dakota Neotoma"
author: "Nick Hoffman"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    highlight: pygment
    keep_md: no
    toc: true
    number_sections: true
    toc_depth: 1
    toc_float: true
    theme: journal
editor_options:
    chunk_output_type: inline
---

<style type="text/css">
h2, h3, h4, h5, h6 {
  counter-reset: section;
}
p {
  font-size:18px;
}

ul {
  font-size:18px;
}

li {
  font-size:18px;
}
table {
   padding: 0;border-collapse: collapse;
   layout: fixed;
   width: 90%; }
table tr {
   border-top: 1px solid #cccccc;
   background-color: white;
   margin: 0;
   padding: 0; }
table tr:nth-child(2n) {
   background-color: #f8f8f8; }
table tr th {
   font-weight: bold;
   border: 1px solid #cccccc;
   margin: 0;
   padding: 6px 13px; }
table tr td {
   border: 1px solid #cccccc;
   margin: 0;
   padding: 6px 13px; }
table tr th :first-child, table tr td :first-child {
   margin-top: 0; }
table tr th :last-child, table tr td :last-child {
   margin-bottom: 0; }
.html-widget {
    margin: auto;
}
</style>

---

```{r setup, warning=FALSE,message=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(dplyr)
library(DT)
library(geojsonsf)
library(osmdata)
library(rosm)
library(tmap)
library(sf)
library(leaflet)

#lats = c(46, 46, 42.42, 42.42)
#lons = c(-104.3, -96, -96, -104.3) 
lats <- c(45.944106, 45.933153, 45.818137, 45.604536, 45.412843, 45.297827, 43.501391, 43.479483, 43.397329, 43.222067, 43.123482, 43.052282, 42.855112, 42.707235, 42.488157, 42.515542, 42.657942, 42.844158, 42.844158, 42.866066, 42.767481, 42.94822, 42.997512, 42.997512, 43.002989, 43.002989, 44.996596, 44.996596, 45.944106)

lons <- c(-104.047534, -96.560556, -96.582464, -96.856311, -96.681049, -96.451017, -96.451017, -96.582464, -96.527695, -96.560556, -96.434587, -96.511264, -96.544125, -96.631756, -96.44554, -96.626279, -96.692003, -97.217789, -97.688806, -97.831206, -97.951699, -98.466531, -98.499393, -101.626726, -103.324578, -104.053011, -104.058488, -104.042057, -104.047534)

# Create a data frame with coordinates
coordinates = data.frame(lat = lats, lon = lons)

# Convert to sf object and create a polygon
coordinates_sf = coordinates %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326) %>%
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")

# Plot to check
tm_shape(osm.raster(coordinates_sf)) +
  tm_rgb() +
  tm_shape(coordinates_sf) +
  tm_polygons(alpha = 0.5)



coord_json = sf_geojson(coordinates_sf)




sites = content(GET(paste0("https://api.neotomadb.org/v2.0/data/sites?loc=",coord_json,"&limit=9999&offset=0")))$data


idx = 0
for (i in seq(length(sites))) {
  for (j in seq(length(sites[[i]]$collectionunits))) {
    for (k in seq(length(sites[[i]]$collectionunits[[j]]$datasets))) {
    idx = idx + 1
    }
    }
}


sites_mat = matrix(nrow=idx,ncol=11)

idx2 = 0
for (i in seq(length(sites))) {
  for (j in seq(length(sites[[i]]$collectionunits))) {
    for (k in seq(length(sites[[i]]$collectionunits[[j]]$datasets))) {
    idx2 = idx2 + 1
    for (m in seq(5)) {
      if (!is.null(sites[[i]][[m]])) {
        sites_mat[[idx2, m]] = sites[[i]][[m]]
      }
    }
    
     if (!is.null(sites[[i]]$collectionunits[[j]]$handle)) {
        sites_mat[[idx2,6]] = sites[[i]]$collectionunits[[j]]$handle
     }
       if (!is.null(sites[[i]]$collectionunits[[j]]$collectionunit)) {
        sites_mat[[idx2,7]] = sites[[i]]$collectionunits[[j]]$collectionunit
       }
       if (!is.null(sites[[i]]$collectionunits[[j]]$collectionunitid)) {
        sites_mat[[idx2,8]] = sites[[i]]$collectionunits[[j]]$collectionunitid
       }
       if (!is.null(sites[[i]]$collectionunits[[j]]$collectionunittype)) {
        sites_mat[[idx2,9]] = sites[[i]]$collectionunits[[j]]$collectionunittype
       }
       if (!is.null(sites[[i]]$collectionunits[[j]]$dataset[[k]]$datasetid)) {
        sites_mat[[idx2,10]] = sites[[i]]$collectionunits[[j]]$dataset[[k]]$datasetid
       }
       if (!is.null(sites[[i]]$collectionunits[[j]]$dataset[[k]]$datasettype)) {
        sites_mat[[idx2,11]] = sites[[i]]$collectionunits[[j]]$dataset[[k]]$datasettype
       }
    }
  }
}

sites_sd_df = as.data.frame(sites_mat)

names(sites_sd_df) = c("siteid","sitename","sitedescription","geography","altitude","handle","collectionunit","collectionunitid","collectionunittype","datasetid","datasettype")

sites_sd_sf = geojson_sf(sites_sd_df$geography) %>% cbind(sites_sd_df)

datasetids = sites_sd_df %>% dplyr::distinct(datasetid) 

#datasets_neo = get_datasets(as.numeric(datasetids$datasetid),all_data=TRUE)

#data = samples(get_downloads(datasets_neo,all_data=TRUE))

datatable(sites_sd_df,rownames=FALSE)

sites_sd_sf_unique = sites_sd_sf %>% distinct(siteid,.keep_all=TRUE)

 pointSites = sites_sd_sf_unique[st_geometry_type(sites_sd_sf_unique) == "POINT",] 
    polySites = sites_sd_sf_unique[st_geometry_type(sites_sd_sf_unique) == "POLYGON",] 


  leaflet() %>%
  addTiles() %>%
  addPolygons(data = polySites, 
              color = "red", 
              weight = 5, 
              fillColor = "orange", 
              fillOpacity = 0.35, 
              popup = ~sitename)  %>%
  addCircleMarkers(data = pointSites, 
                   radius = 5, 
                   color = "blue", 
                   fillColor = "blue", 
                   fillOpacity = 0.2, 
                   stroke = FALSE, 
                   popup = ~sitename)

  
datatable(st_drop_geometry(sites_sd_sf_unique),rownames=FALSE)
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>